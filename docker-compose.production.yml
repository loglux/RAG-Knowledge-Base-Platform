version: '3.8'

# Production Docker Compose Configuration
# Knowledge Base Platform - Full Stack Deployment

services:
  # Frontend - React + Vite (Production Build with Nginx)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.production
    container_name: kb-platform-frontend-prod
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-5174}:80"
    volumes:
      - frontend_logs:/var/log/nginx:rw
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
    networks:
      - kb-network
    depends_on:
      backend:
        condition: service_healthy

  # Backend - FastAPI Application
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: kb-platform-backend-prod
    restart: unless-stopped
    ports:
      - "${BACKEND_PORT:-8004}:8000"
    environment:
      # Application
      - ENVIRONMENT=production
      - DEBUG=false
      - LOG_LEVEL=${LOG_LEVEL:-INFO}

      # API
      - API_HOST=0.0.0.0
      - API_PORT=8000

      # Database
      - DATABASE_URL=postgresql://${POSTGRES_USER:-kb_user}:${POSTGRES_PASSWORD:-kb_pass}@db:5432/${POSTGRES_DB:-knowledge_base}

      # Qdrant
      - QDRANT_URL=http://qdrant:6333

      # OpenSearch
      - OPENSEARCH_URL=http://opensearch:9200

      # LLM Providers (from .env)
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - VOYAGE_API_KEY=${VOYAGE_API_KEY:-}
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-}

      # Security
      - SECRET_KEY=${SECRET_KEY}
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:5174}
    volumes:
      - app_logs:/app/logs:rw
      - uploads:/app/uploads:rw
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - kb-network
    depends_on:
      db:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      opensearch:
        condition: service_healthy

  # PostgreSQL Database
  db:
    image: postgres:16-alpine
    container_name: kb-platform-db-prod
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-kb_user}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-kb_pass}
      - POSTGRES_DB=${POSTGRES_DB:-knowledge_base}
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data:rw
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-kb_user} -d ${POSTGRES_DB:-knowledge_base}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - kb-network
    # Optional: expose port for external access
    # ports:
    #   - "5432:5432"

  # Qdrant Vector Database
  qdrant:
    image: qdrant/qdrant:latest
    container_name: kb-platform-qdrant-prod
    restart: unless-stopped
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
    volumes:
      - qdrant_data:/qdrant/storage:rw
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - kb-network
    # Optional: expose ports for external access
    # ports:
    #   - "6333:6333"
    #   - "6334:6334"

  # OpenSearch - BM25 Lexical Search
  opensearch:
    image: opensearchproject/opensearch:2.11.1
    container_name: kb-platform-opensearch-prod
    restart: unless-stopped
    environment:
      - discovery.type=single-node
      - OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m
      - DISABLE_SECURITY_PLUGIN=true
      - OPENSEARCH_INITIAL_ADMIN_PASSWORD=${OPENSEARCH_PASSWORD:-Admin123!}
    volumes:
      - opensearch_data:/usr/share/opensearch/data:rw
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - kb-network
    # Optional: expose port for external access
    # ports:
    #   - "9200:9200"

# Persistent Volumes
volumes:
  # Database - PostgreSQL data
  postgres_data:
    driver: local
    name: kb_postgres_data_prod

  # Vector Database - Qdrant vectors
  qdrant_data:
    driver: local
    name: kb_qdrant_data_prod

  # Lexical Search - OpenSearch index
  opensearch_data:
    driver: local
    name: kb_opensearch_data_prod

  # Application Logs - Backend
  app_logs:
    driver: local
    name: kb_app_logs_prod

  # Frontend Logs - Nginx
  frontend_logs:
    driver: local
    name: kb_frontend_logs_prod

  # Uploaded Documents
  uploads:
    driver: local
    name: kb_uploads_prod

# Network
networks:
  kb-network:
    name: kb_network_prod
    driver: bridge
